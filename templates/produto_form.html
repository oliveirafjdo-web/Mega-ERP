{% extends "base.html" %}

{% if produto %}
  {% set page_title_txt = 'Editar produto' %}
  {% set icon_class = 'bi-pencil-square' %}
{% else %}
  {% set page_title_txt = 'Novo produto' %}
  {% set icon_class = 'bi-plus-circle' %}
{% endif %}

{% block title %}{{ page_title_txt }} ‚Ä¢ Mega ERP{% endblock %}
{% block page_icon %}<i class="bi {{ icon_class }} text-primary"></i>{% endblock %}
{% block page_title %}{{ page_title_txt }}{% endblock %}

{% block content %}
<div class="card-glass">
  <div class="card-glass-header">
    <div class="card-glass-title">
      <i class="bi bi-box-seam"></i> Dados do produto
    </div>
  </div>

  <form method="post">
    <div class="row g-3">
      <div class="col-12 col-md-6">
        <label class="form-label" for="nome">Nome</label>
        <input
          type="text"
          class="form-control"
          id="nome"
          name="nome"
          required
          value="{{ produto.nome if produto else '' }}"
        >
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label" for="sku">SKU</label>
        <input
          type="text"
          class="form-control"
          id="sku"
          name="sku"
          value="{{ produto.sku if produto else '' }}"
        >
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label" for="custo_unitario">Custo unit√°rio (R$)</label>
        <input
          type="number"
          step="0.01"
          class="form-control"
          id="custo_unitario"
          name="custo_unitario"
          required
          value="{{ '%.2f'|format(produto.custo_unitario) if produto else '' }}"
        >
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label" for="preco_venda_sugerido">Pre√ßo sugerido (R$)</label>
        <input
          type="number"
          step="0.01"
          class="form-control"
          id="preco_venda_sugerido"
          name="preco_venda_sugerido"
          required
          value="{{ '%.2f'|format(produto.preco_venda_sugerido) if produto else '' }}"
        >
      </div>

      {% if produto %}
        <div class="col-12 col-md-3">
          <label class="form-label" for="estoque_atual">Estoque atual</label>
          <input
            type="number"
            class="form-control"
            id="estoque_atual"
            name="estoque_atual"
            required
            value="{{ produto.estoque_atual }}"
          >
        </div>
      {% else %}
        <div class="col-12 col-md-3">
          <label class="form-label" for="estoque_inicial">Estoque inicial</label>
          <input
            type="number"
            class="form-control"
            id="estoque_inicial"
            name="estoque_inicial"
            value="0"
          >
        </div>
      {% endif %}
    </div>

    <div class="mt-3 d-flex gap-2">
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-check2-circle"></i> Salvar
      </button>
      <a href="{{ url_for('lista_produtos') }}" class="btn btn-outline-light">
        <i class="bi bi-arrow-left"></i> Voltar
      </a>
      
      {% if produto %}
        <div class="ms-auto">
          <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
            <i class="bi bi-trash"></i> Deletar Produto
          </button>
        </div>
      {% endif %}
    </div>
  </form>
</div>

{% if produto %}
<!-- Modal para deletar -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark">
      <div class="modal-header border-danger">
        <h5 class="modal-title text-danger">
          <i class="bi bi-exclamation-triangle"></i> Deletar Produto
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Produto:</strong> {{ produto.nome }}</p>
        <p id="vendas-info">Carregando informa√ß√µes...</p>
        
        <div class="alert alert-info mt-3" id="info-area" style="display: none;">
          <strong>Op√ß√µes de exclus√£o:</strong>
          <form method="POST" id="formDeletar">
            <div class="mt-2">
              <label class="form-check">
                <input type="radio" class="form-check-input" name="tipo_delete" value="normal" checked>
                <span class="form-check-label">
                  ‚ùå Deletar apenas o produto (se n√£o tiver vendas)
                </span>
              </label>
            </div>
            <div class="mt-2" id="opcao-com-vendas" style="display: none;">
              <label class="form-check">
                <input type="radio" class="form-check-input" name="tipo_delete" value="com_vendas">
                <span class="form-check-label">
                  üóëÔ∏è Deletar produto E <strong id="vendas-count">?</strong> vendas vinculadas
                  <small class="text-warning d-block ms-5">‚ö†Ô∏è ATEN√á√ÉO: Isso tamb√©m remove as vendas!</small>
                </span>
              </label>
            </div>
          </form>
        </div>
      </div>
      <div class="modal-footer border-danger">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" onclick="confirmarDelete()">
          <i class="bi bi-trash"></i> Deletar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Carregar informa√ß√µes de vendas quando modal abre
document.getElementById('deleteModal').addEventListener('show.bs.modal', function() {
  fetch(`/api/produto-vendas/{{ produto.id }}`)
    .then(r => r.json())
    .then(data => {
      const vendas = data.total;
      const elem = document.getElementById('vendas-info');
      const infoArea = document.getElementById('info-area');
      const opcaoCom = document.getElementById('opcao-com-vendas');
      const vendCount = document.getElementById('vendas-count');
      
      if (vendas === 0) {
        elem.innerHTML = '‚úÖ <strong>Nenhuma venda</strong> vinculada a este produto. Seguro deletar!';
        elem.className = 'text-success';
        infoArea.style.display = 'none';
        opcaoCom.style.display = 'none';
      } else {
        elem.innerHTML = `‚ö†Ô∏è <strong>${vendas} venda(s)</strong> vinculada(s) a este produto.`;
        elem.className = 'text-warning';
        vendCount.textContent = vendas;
        infoArea.style.display = 'block';
        opcaoCom.style.display = 'block';
      }
    })
    .catch(e => {
      document.getElementById('vendas-info').innerHTML = '‚ùå Erro ao carregar informa√ß√µes';
    });
});

function confirmarDelete() {
  const tipo = document.querySelector('input[name="tipo_delete"]:checked').value;
  const msg = tipo === 'normal' 
    ? 'Deletar este produto?' 
    : 'Deletar este produto E TODAS as suas vendas? Isso n√£o pode ser desfeito!';
  
  if (confirm(msg)) {
    const url = tipo === 'normal'
      ? `/produtos/{{ produto.id }}/excluir`
      : `/produtos/{{ produto.id }}/excluir_com_vendas`;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = url;
    document.body.appendChild(form);
    form.submit();
  }
}
</script>
{% endif %}
{% endblock %}
