{% extends "base.html" %}

{% block title %}Imprimir Etiquetas ZPL - Redutron ERP{% endblock %}

{% block content %}
<div class="content-inner">
  <!-- Topbar -->
  <div class="topbar">
    <div class="topbar-title">
      <i class="bi bi-printer"></i>
      Imprimir Etiquetas ZPL
      <span class="badge">Mercado Livre</span>
    </div>
    <div class="topbar-right">
      <div class="topbar-pill">
        <i class="bi bi-info-circle"></i>
        Cole o código ZPL e converta para PDF
      </div>
    </div>
  </div>

  <!-- Card de Instrução -->
  <div class="card-glass">
    <div class="card-glass-header">
      <div class="card-glass-title">
        <i class="bi bi-lightbulb"></i>
        Como Usar
      </div>
    </div>
    <div class="alert alert-info mb-0">
      <strong>Instruções:</strong> Cole o código ZPL que você recebeu do Mercado Livre no campo abaixo. 
      A quantidade de etiquetas será detectada automaticamente do código (comando ^PQ), mas você pode alterar manualmente se necessário. 
      Ajuste o tamanho da etiqueta e clique em "Gerar PDF" para fazer o download.
    </div>
  </div>

  <!-- Formulário de Conversão -->
  <div class="card-glass">
    <div class="card-glass-header">
      <div class="card-glass-title">
        <i class="bi bi-code-square"></i>
        Código ZPL da Etiqueta
      </div>
    </div>

    <form method="POST" action="{{ url_for('etiquetas_zpl') }}">
      <!-- Tamanho da Etiqueta -->
      <div class="row mb-4">
        <div class="col-md-4">
          <label for="largura_cm" class="form-label" style="font-weight: 600; color: var(--heading);">
            <i class="bi bi-arrows-expand"></i> Largura (cm)
          </label>
          <input 
            type="number" 
            class="form-control" 
            id="largura_cm" 
            name="largura_cm" 
            value="4" 
            step="0.1" 
            min="1" 
            max="50"
            required
            style="border: 1px solid var(--border); border-radius: .9rem; padding: .75rem 1rem;"
          >
          <small class="text-muted" style="display: block; margin-top: .5rem;">
            <i class="bi bi-info-circle"></i> Full: 4 cm | 10x15: 10 cm
          </small>
        </div>
        <div class="col-md-4">
          <label for="altura_cm" class="form-label" style="font-weight: 600; color: var(--heading);">
            <i class="bi bi-arrows-vertical"></i> Altura (cm)
          </label>
          <input 
            type="number" 
            class="form-control" 
            id="altura_cm" 
            name="altura_cm" 
            value="2.5" 
            step="0.1" 
            min="1" 
            max="50"
            required
            style="border: 1px solid var(--border); border-radius: .9rem; padding: .75rem 1rem;"
          >
          <small class="text-muted" style="display: block; margin-top: .5rem;">
            <i class="bi bi-info-circle"></i> Full: 2.5 cm | 10x15: 15 cm
          </small>
        </div>
        <div class="col-md-4">
          <label for="quantidade" class="form-label" style="font-weight: 600; color: var(--heading);">
            <i class="bi bi-stack"></i> Quantidade
          </label>
          <input 
            type="number" 
            class="form-control" 
            id="quantidade" 
            name="quantidade" 
            value="1" 
            min="1" 
            max="10000"
            required
            style="border: 1px solid var(--border); border-radius: .9rem; padding: .75rem 1rem;"
            oninput="detectarQuantidadeZPL()"
          >
          <small class="text-muted" style="display: block; margin-top: .5rem;">
            <i class="bi bi-info-circle"></i> Número de etiquetas
          </small>
        </div>
      </div>

      <div class="mb-4">
        <label for="zpl_code" class="form-label" style="font-weight: 600; color: var(--heading);">
          <i class="bi bi-file-earmark-code"></i> Código ZPL
        </label>
        <textarea 
          class="form-control" 
          id="zpl_code" 
          name="zpl_code" 
          rows="15" 
          placeholder="Cole aqui o código ZPL do Mercado Livre, exemplo:
^XA
^CI28
^LH0,0
^FO25,15^BY2,,0^BCN,55,N,N^FDHOEK26471^FS
^FT110,98^A0N,22,22^FH^FDHOEK26471^FS
...
^XZ"
          required
          style="font-family: 'Courier New', monospace; font-size: 13px; background: #f8f9fa; border: 1px solid var(--border); border-radius: .9rem; padding: 1rem;"
        ></textarea>
        <small class="text-muted" style="display: block; margin-top: .5rem;">
          <i class="bi bi-info-circle"></i> O código ZPL geralmente começa com ^XA e termina com ^XZ
        </small>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-file-earmark-pdf"></i>
          Gerar PDF da Etiqueta
        </button>
        <button type="reset" class="btn btn-outline-light">
          <i class="bi bi-x-circle"></i>
          Limpar
        </button>
      </div>
    </form>
  </div>

  <!-- Exemplo de Código ZPL -->
  <div class="card-glass">
    <div class="card-glass-header">
      <div class="card-glass-title">
        <i class="bi bi-book"></i>
        Exemplo de Código ZPL
      </div>
    </div>
    <div style="background: #f8f9fa; padding: 1rem; border-radius: .9rem; border: 1px solid var(--border);">
      <pre style="margin: 0; font-family: 'Courier New', monospace; font-size: 12px; color: #1f2937; white-space: pre-wrap; word-wrap: break-word;">^XA
^CI28
^LH0,0
^FO25,15^BY2,,0^BCN,55,N,N^FDHOEK26471^FS
^FT110,98^A0N,22,22^FH^FDHOEK26471^FS
^FT109,98^A0N,22,22^FH^FDHOEK26471^FS
^FO22,115^A0N,18,18^FB300,2,0,L^FH^FDAdaptador Ssd M2 Nvme Gen4 Para Pci_2De 4_2E0 X4 X8 X16 64gbps Marca Redutron^FS
^FO22,153^A0N,18,18^FB300,1,0,L^FH^FD^FS
^FO21,153^A0N,18,18^FB300,1,0,L^FH^FD^FS
^FO22,175^A0N,18,18^FH^FDSKU: X4_2D4_2E0^FS
^FO22,175^A0N,18,18^FH^FD^FS
^PQ1,0,1,Y^XZ</pre>
    </div>
    <small class="text-muted" style="display: block; margin-top: .75rem;">
      <i class="bi bi-arrow-up-circle"></i> Este é um exemplo típico de etiqueta do Mercado Livre. Cole seu código real no campo acima.
    </small>
  </div>

  <!-- Informações Técnicas -->
  <div class="card-glass">
    <div class="card-glass-header">
      <div class="card-glass-title">
        <i class="bi bi-gear"></i>
        Informações Técnicas
      </div>
    </div>
    <div class="row g-3">
      <div class="col-md-3">
        <div style="padding: 1rem; background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(37, 99, 235, 0.03)); border-radius: .9rem; border: 1px solid rgba(37, 99, 235, 0.15);">
          <div style="font-weight: 600; color: var(--heading); margin-bottom: .5rem;">
            <i class="bi bi-star-fill"></i> Full (Padrão)
          </div>
          <div style="font-size: 13px; color: var(--muted);">
            4 x 2.5 cm
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div style="padding: 1rem; background: linear-gradient(135deg, rgba(168, 85, 247, 0.08), rgba(168, 85, 247, 0.03)); border-radius: .9rem; border: 1px solid rgba(168, 85, 247, 0.15);">
          <div style="font-weight: 600; color: var(--heading); margin-bottom: .5rem;">
            <i class="bi bi-box"></i> Grande
          </div>
          <div style="font-size: 13px; color: var(--muted);">
            10 x 15 cm (4" x 6")
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div style="padding: 1rem; background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.03)); border-radius: .9rem; border: 1px solid rgba(16, 185, 129, 0.15);">
          <div style="font-weight: 600; color: var(--heading); margin-bottom: .5rem;">
            <i class="bi bi-droplet"></i> Resolução
          </div>
          <div style="font-size: 13px; color: var(--muted);">
            8 dots/mm (203 DPI)
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div style="padding: 1rem; background: linear-gradient(135deg, rgba(249, 115, 22, 0.08), rgba(249, 115, 22, 0.03)); border-radius: .9rem; border: 1px solid rgba(249, 115, 22, 0.15);">
          <div style="font-weight: 600; color: var(--heading); margin-bottom: .5rem;">
            <i class="bi bi-file-pdf"></i> Formato
          </div>
          <div style="font-size: 13px; color: var(--muted);">
            PDF para impressão
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .form-control:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.15);
  }

  .alert-info {
    background: rgba(14, 165, 233, 0.1);
    border-color: rgba(14, 165, 233, 0.35);
    color: #075985;
  }

  pre {
    max-height: 300px;
    overflow-y: auto;
  }

  pre::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  pre::-webkit-scrollbar-track {
    background: #e5e7eb;
    border-radius: 4px;
  }

  pre::-webkit-scrollbar-thumb {
    background: #9ca3af;
    border-radius: 4px;
  }

  pre::-webkit-scrollbar-thumb:hover {
    background: #6b7280;
  }
</style>

<script>
function detectarQuantidadeZPL() {
  const zplCode = document.getElementById('zpl_code').value;
  const quantidadeInput = document.getElementById('quantidade');
  
  // Procurar pelo comando ^PQ no código ZPL
  const match = zplCode.match(/\^PQ(\d+)/i);
  
  if (match && match[1]) {
    const qtdDetectada = parseInt(match[1]);
    if (qtdDetectada > 0 && qtdDetectada <= 10000) {
      quantidadeInput.value = qtdDetectada;
      
      // Mostrar feedback visual
      quantidadeInput.style.borderColor = '#16a34a';
      quantidadeInput.style.background = 'rgba(34, 197, 94, 0.05)';
      
      setTimeout(() => {
        quantidadeInput.style.borderColor = '';
        quantidadeInput.style.background = '';
      }, 1500);
    }
  }
}

// Detectar quantidade automaticamente quando colar o código
document.addEventListener('DOMContentLoaded', function() {
  const zplTextarea = document.getElementById('zpl_code');
  
  if (zplTextarea) {
    zplTextarea.addEventListener('input', detectarQuantidadeZPL);
    zplTextarea.addEventListener('paste', function() {
      setTimeout(detectarQuantidadeZPL, 100);
    });
  }
});
</script>
{% endblock %}
