{% extends "base.html" %}
{% block title %}Vendas - Mega ERP{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <!-- =========================== -->
    <!-- (BOT√ÉO DE AJUSTE REMOVIDO) -->
    <!-- =========================== -->
    {# Bot√£o de ajuste de estoque removido desta tela #}

    <!-- =========================== -->
    <!-- FILTROS (STICKY) + BUSCA + A√á√ïES -->
    <!-- =========================== -->
    <div class="card shadow-sm mb-4 sticky-top" style="top: 1rem; z-index: 10;">
        <div class="card-body">
            <form class="row g-3 align-items-end" method="GET" id="formPeriodo">
                <!-- Bot√µes r√°pidos de per√≠odo -->
                <div class="col-12">
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setQuickPeriod(0)">
                            <i class="bi bi-calendar-day me-1"></i> Hoje
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setQuickPeriod(7)">
                            <i class="bi bi-calendar-week me-1"></i> 7 dias
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setQuickPeriod(30)">
                            <i class="bi bi-calendar-month me-1"></i> 30 dias
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setCurrentMonth()">
                            <i class="bi bi-calendar-check me-1"></i> Este m√™s
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setLastMonth()">
                            <i class="bi bi-calendar me-1"></i> M√™s anterior
                        </button>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Data in√≠cio</label>
                    <input type="date" name="data_inicio" id="data_inicio" class="form-control" value="{{ data_inicio }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Data fim</label>
                    <input type="date" name="data_fim" id="data_fim" class="form-control" value="{{ data_fim }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Buscar produto / N¬∫ ML</label>
                    <div class="input-group">
                        <span class="input-group-text">üîç</span>
                        <input id="buscaVendas" type="text" class="form-control" placeholder="Digite para filtrar..." onkeyup="filtrarTabelaVendas()">
                    </div>
                </div>
                <div class="col-md-3 d-flex gap-2 justify-content-end">
                    <a href="{{ url_for('exportar_consolidado') }}" class="btn btn-outline-secondary flex-grow-1">‚¨á Exportar XLSX</a>
                    <button class="btn btn-primary flex-grow-1" type="submit">Aplicar</button>
                </div>
            </form>

            <!-- Chips de filtro r√°pido -->
            <div class="d-flex flex-wrap gap-2 mt-3">
                <div class="text-muted small">Origem:</div>
                <button class="btn btn-sm btn-outline-dark" data-origem="" onclick="setOrigemFiltro(this)">Todas</button>
                <button class="btn btn-sm btn-outline-primary" data-origem="Mercado Livre" onclick="setOrigemFiltro(this)">Mercado Livre</button>
                <button class="btn btn-sm btn-outline-success" data-origem="Manual" onclick="setOrigemFiltro(this)">Manual</button>

                <div class="text-muted small ms-3">Status:</div>
                <button class="btn btn-sm btn-outline-dark" data-status="" onclick="setStatusFiltro(this)">Todos</button>
                <button class="btn btn-sm btn-outline-success" data-status="ok" onclick="setStatusFiltro(this)">Ativas</button>
                <button class="btn btn-sm btn-outline-danger" data-status="cancelada" onclick="setStatusFiltro(this)">Canceladas</button>
            </div>
        </div>
    </div>

    <!-- =========================== -->
    <!-- TOTAIS NO TOPO -->
    <!-- =========================== -->
    <div class="row mb-4 g-3">
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">Total de Vendas</div>
                    <div class="d-flex justify-content-center align-items-center gap-2">
                        <span class="fs-4">üßæ</span>
                        <h3 class="mb-0">{{ totais.qtd }}</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">Faturamento Total</div>
                    <div class="d-flex justify-content-center align-items-center gap-2">
                        <span class="fs-4 text-primary">üíµ</span>
                        <h3 class="mb-0">R$ {{ "%.2f"|format(totais.receita or 0) }}</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">Custo Total</div>
                    <div class="d-flex justify-content-center align-items-center gap-2">
                        <span class="fs-4 text-secondary">üì¶</span>
                        <h3 class="mb-0">R$ {{ "%.2f"|format(totais.custo or 0) }}</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">Lucro L√≠quido</div>
                    <div class="d-flex justify-content-center align-items-center gap-2">
                        <span class="fs-4 text-success">üìà</span>
                        <h3 class="mb-0">R$ {{ "%.2f"|format(totais.lucro_liquido or 0) }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- =========================== -->
    <!-- GR√ÅFICOS -->
    <!-- =========================== -->
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">Faturamento di√°rio</div>
                <div class="card-body">
                    <canvas id="chartFaturamento" style="height:260px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">Quantidade vendida por dia</div>
                <div class="card-body">
                    <canvas id="chartQuantidade" style="height:260px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header">Lucro di√°rio</div>
                <div class="card-body">
                    <canvas id="chartLucro" style="height:260px;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
<div class="card shadow-sm">
<div class="card-header">Receita L√≠quida Di√°ria (Receita - Comiss√£o ML)</div>
<div class="card-body">
<canvas id="chartReceitaLiquida" style="height:260px;"></canvas>
</div>
</div>
</div>

        <!-- =========================== -->
        <!-- NOVO: PIZZA POR ESTADO (UF) -->
        <!-- =========================== -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Vendas por Estado (UF)</span>
                    <small class="text-muted">Baseado no per√≠odo filtrado</small>
                </div>
                <div class="card-body">
                    {% if pizza_estados_labels and pizza_estados_valores %}
                        <canvas id="chartPizzaEstados" style="height:260px;"></canvas>
                    {% else %}
                        <div class="text-muted">
                            Nenhum dado de UF encontrado. Verifique se sua tabela <b>vendas</b> possui coluna
                            <b>uf/estado</b> (ou ajuste o nome no backend).
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- =========================== -->
        <!-- PRODUTOS MAIS VENDIDOS -->
        <!-- =========================== -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>üî• Top 10 Mais Vendidos (Quantidade)</span>
                    <small class="text-muted">Baseado no per√≠odo filtrado</small>
                </div>
                <div class="card-body">
                    {% if pizza_mais_vendidos_labels and pizza_mais_vendidos_valores %}
                        <canvas id="chartMaisVendidos" style="height:260px;"></canvas>
                    {% else %}
                        <div class="text-muted">
                            Nenhum dado de produto encontrado no per√≠odo selecionado.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- =========================== -->
        <!-- PRODUTOS MAIS LUCRATIVOS -->
        <!-- =========================== -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>üí∞ Top 10 Mais Lucrativos</span>
                    <small class="text-muted">Baseado no per√≠odo filtrado</small>
                </div>
                <div class="card-body">
                    {% if pizza_mais_lucrativos_labels and pizza_mais_lucrativos_valores %}
                        <canvas id="chartMaisLucrativos" style="height:260px;"></canvas>
                    {% else %}
                        <div class="text-muted">
                            Nenhum dado de produto encontrado no per√≠odo selecionado.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- =========================== -->
        <!-- PRODUTOS MENOS LUCRATIVOS -->
        <!-- =========================== -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>‚ö†Ô∏è Top 10 Menos Lucrativos</span>
                    <small class="text-muted">Baseado no per√≠odo filtrado</small>
                </div>
                <div class="card-body">
                    {% if pizza_menos_lucrativos_labels and pizza_menos_lucrativos_valores %}
                        <canvas id="chartMenosLucrativos" style="height:260px;"></canvas>
                    {% else %}
                        <div class="text-muted">
                            Nenhum dado de produto encontrado no per√≠odo selecionado.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>

    <!-- =========================== -->
    <!-- LOTES IMPORTADOS -->
    <!-- =========================== -->
    <h3 class="mt-4 mb-3">Lotes importados</h3>
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Lote</th>
                <th>Quantidade</th>
                <th>Faturamento</th>
                <th>A√ß√£o</th>
            </tr>
        </thead>
        <tbody>
            {% for lote in lotes %}
            <tr>
                <td>{{ lote.lote_importacao }}</td>
                <td>{{ lote.qtd_vendas }}</td>
                <td>R$ {{ "%.2f"|format(lote.receita_lote) }}</td>
                <td>
                    <form method="post" action="{{ url_for('excluir_lote_venda', lote=lote.lote_importacao) }}" onsubmit="return confirm('Excluir todas as vendas desse lote?');">
                        <button class="btn btn-danger btn-sm">Excluir lote</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- =========================== -->
    <!-- LISTA DE VENDAS -->
    <!-- =========================== -->
    <h3 class="mt-5 mb-3">Lista de vendas</h3>
    <table class="table table-striped table-hover align-middle" id="tabelaVendas">
        <thead class="table-light">
            <tr>
                <th>Data</th>
                <th>Produto</th>
                <th class="text-end">Qtd</th>
                <th class="text-end">Receita</th>
                <th class="text-end">Custo</th>
                <th class="text-end">Lucro</th>
                <th>Origem</th>
                <th>N¬∫ ML</th>
            </tr>
        </thead>
        <tbody>
            {% for v in vendas %}
            {% set cancelada = v.receita_total <= 0 %}
            <tr data-origem="{{ v.origem or '' }}" data-status="{{ 'cancelada' if cancelada else 'ok' }}">
                <td>{{ v.data_venda[:10] }}</td>
                <td>
                    {{ v.nome }}
                    {% if cancelada %}
                        <span class="badge bg-danger ms-2">‚õî Cancelada</span>
                    {% endif %}
                </td>
                <td class="text-end">{{ v.quantidade }}</td>
                <td class="text-end">R$ {{ "%.2f"|format(v.receita_total) }}</td>
                <td class="text-end">R$ {{ "%.2f"|format(v.custo_total) }}</td>
                <td class="text-end">R$ {{ "%.2f"|format(v.margem_contribuicao) }}</td>
                <td>
                    {% if v.origem == 'Mercado Livre' %}
                        <span class="badge bg-primary">üõí Mercado Livre</span>
                    {% elif v.origem %}
                        <span class="badge bg-success">üìã {{ v.origem }}</span>
                    {% else %}
                        <span class="badge bg-secondary">‚Äî</span>
                    {% endif %}
                </td>
                <td>{{ v.numero_venda_ml }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- PAGINA√á√ÉO -->
    <nav aria-label="Vendas pagination">
      <ul class="pagination justify-content-center">
        {% for p in range(1, total_pages+1) %}
        <li class="page-item {% if p==current_page %}active{% endif %}">
          <a class="page-link"
            href="?data_inicio={{ data_inicio }}&data_fim={{ data_fim }}&page={{ p }}">{{ p }}</a>
        </li>
        {% endfor %}
      </ul>
    </nav>

</div>

<!-- Chart.js + DataLabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
// registra o plugin para garantir que os valores apare√ßam
if (window.ChartDataLabels) {
    Chart.register(ChartDataLabels);
}

const labels = {{ grafico_labels|tojson }};
const dadosFaturamento = {{ grafico_faturamento|tojson }};
const dadosQuantidade = {{ grafico_quantidade|tojson }};
const dadosLucro = {{ grafico_lucro|tojson }};
const dadosReceitaLiquida = {{ grafico_receita_liquida|tojson }};

// NOVO: Pizza por estado
const pizzaEstadosLabels = {{ pizza_estados_labels|default([])|tojson }};
const pizzaEstadosValores = {{ pizza_estados_valores|default([])|tojson }};

// NOVO: Produtos mais vendidos
const pizzaMaisVendidosLabels = {{ pizza_mais_vendidos_labels|default([])|tojson }};
const pizzaMaisVendidosValores = {{ pizza_mais_vendidos_valores|default([])|tojson }};

// NOVO: Produtos mais lucrativos
const pizzaMaisLucrativosLabels = {{ pizza_mais_lucrativos_labels|default([])|tojson }};
const pizzaMaisLucrativosValores = {{ pizza_mais_lucrativos_valores|default([])|tojson }};

// NOVO: Produtos menos lucrativos
const pizzaMenosLucrativosLabels = {{ pizza_menos_lucrativos_labels|default([])|tojson }};
const pizzaMenosLucrativosValores = {{ pizza_menos_lucrativos_valores|default([])|tojson }};

const baseConfig = {
    plugins: {
        datalabels: {
            display: true,
            color: "#000",
            anchor: "end",
            align: "top",
            font: { weight: "bold", size: 11 },
            formatter: value => {
                if (value === null || value === undefined || Number(value) === 0) {
                    return "";
                }
                return Number(value).toLocaleString("pt-BR");
            }
        },
        legend: { display: true }
    },
    responsive: true,
    scales: {
        x: { ticks: { maxRotation: 45, minRotation: 45 } },
        y: { beginAtZero: true }
    }
};

new Chart(document.getElementById("chartFaturamento"), {
    type: "line",
    data: {
        labels,
        datasets: [{
            label: "Faturamento (R$)",
            data: dadosFaturamento,
            borderColor: "#3498db",
            backgroundColor: "rgba(52,152,219,0.3)",
            fill: true,
            tension: 0.3,
            pointRadius: 4
        }]
    },
    options: baseConfig
});

new Chart(document.getElementById("chartQuantidade"), {
    type: "bar",
    data: {
        labels,
        datasets: [{
            label: "Quantidade",
            data: dadosQuantidade,
            backgroundColor: "#1E90FF",
            borderColor: "#1E90FF",
            borderWidth: 1
        }]
    },
    options: baseConfig
});

new Chart(document.getElementById("chartLucro"), {
    type: "line",
    data: {
        labels,
        datasets: [{
            label: "Lucro (R$)",
            data: dadosLucro,
            borderColor: "#2ecc71",
            backgroundColor: "rgba(46,204,113,0.3)",
            fill: true,
            tension: 0.3,
            pointRadius: 4
        }]
    },
    options: baseConfig
});


new Chart(document.getElementById("chartReceitaLiquida"), {
    type: "bar",
    data: {
        labels,
        datasets: [{
            label: "Receita L√≠quida (R$)",
            data: dadosReceitaLiquida,
            backgroundColor: "#9b59b6",
            borderColor: "#8e44ad",
            borderWidth: 2
        }]
    },
    options: baseConfig
});

// ===========================
// NOVO: DOUGHNUT por Estado (UF)
// ===========================
const canvasPizza = document.getElementById("chartPizzaEstados");
if (canvasPizza && pizzaEstadosLabels.length > 0) {
    // Garantir que os labels sejam strings v√°lidas (siglas de UF)
    const validLabels = pizzaEstadosLabels.map(label => (label || "").toString().trim()).filter(l => l && l !== "N/I");
    const validValues = validLabels.length > 0 ? pizzaEstadosValores.slice(0, validLabels.length) : [];
    
    if (validLabels.length > 0) {
        new Chart(canvasPizza, {
            type: "doughnut",
            data: {
                labels: validLabels,
                datasets: [{
                    data: validValues
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true, position: "bottom" },
                    datalabels: {
                        display: true,
                        color: "#fff",
                    font: { weight: "bold", size: 12 },
                    formatter: (value, ctx) => {
                        const total = (ctx.chart.data.datasets[0].data || []).reduce((a, b) => a + Number(b || 0), 0);
                        if (!total || !value) return "";
                        const pct = (Number(value) / total) * 100;
                        // mostra % (e evita poluir se for muito pequeno)
                        if (pct < 3) return "";
                        const label = ctx.chart.data.labels[ctx.dataIndex] || "";
                        return label + "\n" + pct.toFixed(1).replace(".", ",") + "%";
                    }
                }
            }
        }
    });
    }
}

// ===========================
// NOVO: DOUGHNUT Top 10 Mais Vendidos
// ===========================
const canvasMaisVendidos = document.getElementById("chartMaisVendidos");
if (canvasMaisVendidos && pizzaMaisVendidosLabels.length > 0) {
    new Chart(canvasMaisVendidos, {
        type: "doughnut",
        data: {
            labels: pizzaMaisVendidosLabels,
            datasets: [{
                data: pizzaMaisVendidosValores,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true, position: "bottom" },
                datalabels: {
                    display: true,
                    color: "#fff",
                    font: { weight: "bold", size: 11 },
                    formatter: (value, ctx) => {
                        const total = (ctx.chart.data.datasets[0].data || []).reduce((a, b) => a + Number(b || 0), 0);
                        if (!total || !value) return "";
                        const pct = (Number(value) / total) * 100;
                        if (pct < 3) return "";
                        const label = ctx.chart.data.labels[ctx.dataIndex] || "";
                        return label + "\n" + pct.toFixed(1).replace(".", ",") + "%";
                    }
                }
            }
        }
    });
}

// ===========================
// NOVO: DOUGHNUT Top 10 Mais Lucrativos
// ===========================
const canvasMaisLucrativos = document.getElementById("chartMaisLucrativos");
if (canvasMaisLucrativos && pizzaMaisLucrativosLabels.length > 0) {
    new Chart(canvasMaisLucrativos, {
        type: "doughnut",
        data: {
            labels: pizzaMaisLucrativosLabels,
            datasets: [{
                data: pizzaMaisLucrativosValores,
                backgroundColor: [
                    '#4BC0C0', '#36A2EB', '#FFCE56', '#FF6384', '#9966FF',
                    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#36A2EB'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true, position: "bottom" },
                datalabels: {
                    display: true,
                    color: "#fff",
                    font: { weight: "bold", size: 11 },
                    formatter: (value, ctx) => {
                        const total = (ctx.chart.data.datasets[0].data || []).reduce((a, b) => a + Number(b || 0), 0);
                        if (!total || !value) return "";
                        const pct = (Number(value) / total) * 100;
                        if (pct < 3) return "";
                        const label = ctx.chart.data.labels[ctx.dataIndex] || "";
                        return label + "\n" + pct.toFixed(1).replace(".", ",") + "%";
                    }
                }
            }
        }
    });
}

// ===========================
// NOVO: DOUGHNUT Top 10 Menos Lucrativos
// ===========================
const canvasMenosLucrativos = document.getElementById("chartMenosLucrativos");
if (canvasMenosLucrativos && pizzaMenosLucrativosLabels.length > 0) {
    new Chart(canvasMenosLucrativos, {
        type: "doughnut",
        data: {
            labels: pizzaMenosLucrativosLabels,
            datasets: [{
                data: pizzaMenosLucrativosValores,
                backgroundColor: [
                    '#FF6384', '#E7E9ED', '#FF9F40', '#FFCE56', '#C9CBCF',
                    '#FF6384', '#36A2EB', '#4BC0C0', '#9966FF', '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true, position: "bottom" },
                datalabels: {
                    display: true,
                    color: "#fff",
                    font: { weight: "bold", size: 11 },
                    formatter: (value, ctx) => {
                        const total = (ctx.chart.data.datasets[0].data || []).reduce((a, b) => a + Number(b || 0), 0);
                        if (!total || !value) return "";
                        const pct = (Number(value) / total) * 100;
                        if (pct < 3) return "";
                        const label = ctx.chart.data.labels[ctx.dataIndex] || "";
                        return label + "\n" + pct.toFixed(1).replace(".", ",") + "%";
                    }
                }
            }
        }
    });
}

// ===========================
// FILTROS CLIENT-SIDE (busca, origem, status)
// ===========================
let filtroOrigem = "";
let filtroStatus = "";

function setOrigemFiltro(btn) {
    filtroOrigem = btn.dataset.origem || "";
    marcarAtivo(btn, "data-origem");
    filtrarTabelaVendas();
}

function setStatusFiltro(btn) {
    filtroStatus = btn.dataset.status || "";
    marcarAtivo(btn, "data-status");
    filtrarTabelaVendas();
}

function marcarAtivo(btn, dataAttr) {
    document.querySelectorAll(`[${dataAttr}]`).forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
}

function filtrarTabelaVendas() {
    const busca = (document.getElementById("buscaVendas")?.value || "").toLowerCase();
    const linhas = document.querySelectorAll("#tabelaVendas tbody tr");

    linhas.forEach(l => {
        const origem = (l.dataset.origem || "").toLowerCase();
        const status = (l.dataset.status || "").toLowerCase();
        const texto = l.textContent.toLowerCase();

        const matchBusca = !busca || texto.includes(busca);
        const matchOrigem = !filtroOrigem || origem === filtroOrigem.toLowerCase();
        const matchStatus = !filtroStatus || status === filtroStatus.toLowerCase();

        l.style.display = (matchBusca && matchOrigem && matchStatus) ? "" : "none";
    });
}

document.addEventListener("DOMContentLoaded", () => {
    // Marcar defaults
    const origemDefault = document.querySelector('[data-origem=""]');
    if (origemDefault) origemDefault.classList.add("active");
    const statusDefault = document.querySelector('[data-status=""]');
    if (statusDefault) statusDefault.classList.add("active");
});

// Fun√ß√µes de per√≠odo r√°pido
function setQuickPeriod(days) {
    const hoje = new Date();
    const dataFim = hoje.toISOString().split('T')[0];
    
    let dataInicio;
    if (days === 0) {
        dataInicio = dataFim;
    } else {
        const inicio = new Date();
        inicio.setDate(inicio.getDate() - days);
        dataInicio = inicio.toISOString().split('T')[0];
    }
    
    document.getElementById('data_inicio').value = dataInicio;
    document.getElementById('data_fim').value = dataFim;
    document.getElementById('formPeriodo').submit();
}

function setCurrentMonth() {
    const hoje = new Date();
    const ano = hoje.getFullYear();
    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
    
    const dataInicio = `${ano}-${mes}-01`;
    const dataFim = hoje.toISOString().split('T')[0];
    
    document.getElementById('data_inicio').value = dataInicio;
    document.getElementById('data_fim').value = dataFim;
    document.getElementById('formPeriodo').submit();
}

function setLastMonth() {
    const hoje = new Date();
    const primeiroDiaEstem√™s = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    const ultimoDiaMesAnterior = new Date(primeiroDiaEstem√™s.getTime() - 1);
    const primeiroDiaMesAnterior = new Date(ultimoDiaMesAnterior.getFullYear(), ultimoDiaMesAnterior.getMonth(), 1);
    
    const dataInicio = primeiroDiaMesAnterior.toISOString().split('T')[0];
    const dataFim = ultimoDiaMesAnterior.toISOString().split('T')[0];
    
    document.getElementById('data_inicio').value = dataInicio;
    document.getElementById('data_fim').value = dataFim;
    document.getElementById('formPeriodo').submit();
}
</script>

{% endblock %}
